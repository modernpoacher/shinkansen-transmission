"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.toNull=toNull;exports.toBoolean=toBoolean;exports.toString=toString;exports.toNumber=toNumber;exports.transformValueFor=transformValueFor;exports.getArrayFor=getArrayFor;exports.transformArrayFor=transformArrayFor;exports.transformObjectFor=transformObjectFor;exports.transformItemsArrayFor=transformItemsArrayFor;exports.transformItemsObjectFor=transformItemsObjectFor;exports.transformObjectSchemaNull=transformObjectSchemaNull;exports.transformObjectSchemaBoolean=transformObjectSchemaBoolean;exports.transformObjectSchemaObject=transformObjectSchemaObject;exports.transformObjectSchemaArray=transformObjectSchemaArray;exports.transformObjectSchemaNumber=transformObjectSchemaNumber;exports.transformObjectSchemaString=transformObjectSchemaString;exports.transformObjectSchema=transformObjectSchema;exports.transformArraySchemaNull=transformArraySchemaNull;exports.transformArraySchemaBoolean=transformArraySchemaBoolean;exports.transformArraySchemaObject=transformArraySchemaObject;exports.transformArraySchemaArray=transformArraySchemaArray;exports.transformArraySchemaNumber=transformArraySchemaNumber;exports.transformArraySchemaString=transformArraySchemaString;exports.transformArraySchema=transformArraySchema;exports.transformNull=transformNull;exports.transformBoolean=transformBoolean;exports.transformObject=transformObject;exports.transformArray=transformArray;exports.transformNumber=transformNumber;exports.transformString=transformString;exports.default=transform;exports.transformValue=void 0;var _debug=_interopRequireDefault(require("debug"));var _common=require("../common");function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}const log=(0,_debug.default)('shinkansen-transmission:from-hash-to-document:log');const error=(0,_debug.default)('shinkansen-transmission:from-hash-to-document:error');function toNull(v){if(v===null||v==='null')return null;throw new Error('Invalid `null`');}function toBoolean(v){if(typeof v==='boolean')return v;if(v==='true')return true;if(v==='false')return false;throw new Error('Invalid `boolean`');}function toString(v){if(typeof v==='string')return v;if(typeof v==='number')return String(v);return JSON.stringify(v);}function toNumber(v){if(typeof v==='number')return v;if(v){const n=Number(v);if(!isNaN(n))return n;}throw new Error('Invalid `number`');}const transformValue=schema=>(0,_common.isObject)(schema)?(0,_common.isConstValue)(schema)?(0,_common.toConstValue)(schema):(0,_common.isDefaultValue)(schema)?(0,_common.toDefaultValue)(schema):schema:schema;exports.transformValue=transformValue;function transformValueFor(value,array){try{const i=toNumber(value);if(Reflect.has(array,i)){const v=Reflect.get(array,i);return transformValue(v);}}catch({message='No error message defined'}){error(message);}return value;}function getArrayFor(array=[],values,uri){if(Reflect.has(values,uri)){const v=Reflect.get(values,uri);const i=Number(v);if(!isNaN(i))return array[i];}return[];}function transformArrayFor({items=null},values,parentUri,uri){if((0,_common.isArray)(items)){return transformItemsArrayFor(items,values,parentUri,uri);}else{if((0,_common.isObject)(items)){return transformItemsObjectFor(items,values,parentUri,uri);}}return[];}function transformObjectFor({properties=null},values,parentUri,uri){if((0,_common.isObject)(properties)){return Object.entries(properties).reduce((accumulator,[key,schema])=>{const schemaUri=(0,_common.getUri)(parentUri,key);return{...accumulator,[key]:transform(schema,values,schemaUri,schemaUri)};},{});}return{};}function transformItemsArrayFor(items=[],values,parentUri,uri){if(Reflect.has(values,uri)){const value=Reflect.get(values,uri);if((0,_common.isArray)(value)){return transform(items,values,uri,uri);}}return Object.keys(values).filter(key=>key.startsWith(uri)).reduce((accumulator,key)=>{const v=uri.endsWith('/')?key.slice(uri.length):key.slice(uri.length+1);const i=v?Number(v.includes('/')?v.slice(0,v.indexOf('/')):v):NaN;if(!isNaN(i)){const schemaUri=(0,_common.getUri)(parentUri,i);accumulator[i]=transform(items[i],values,schemaUri,schemaUri);}return accumulator;},[]);}function transformItemsObjectFor(items={},values,parentUri,uri){if(Reflect.has(values,uri)){const value=Reflect.get(values,uri);if((0,_common.isArray)(value)){return transform(items,values,uri,uri);}}return Object.keys(values).filter(key=>key.startsWith(uri)).reduce((accumulator,key)=>{const v=uri.endsWith('/')?key.slice(uri.length):key.slice(uri.length+1);const i=v?Number(v.includes('/')?v.slice(0,v.indexOf('/')):v):NaN;if(!isNaN(i)){const schemaUri=(0,_common.getUri)(parentUri,i);accumulator[i]=transform(items,values,schemaUri,schemaUri);}return accumulator;},[]);}const handleError=({message='No error message defined'})=>error(message);function transformObjectSchemaNull(schema,values,{uri:parentUri,key:fieldKey},uri=(0,_common.getUri)(parentUri,fieldKey)){return transformNull(schema,values,parentUri,uri);}function transformObjectSchemaBoolean(schema,values,{uri:parentUri,key:fieldKey},uri=(0,_common.getUri)(parentUri,fieldKey)){return transformBoolean(schema,values,parentUri,uri);}function transformObjectSchemaObject(schema,values,{uri:parentUri,key:fieldKey},uri=(0,_common.getUri)(parentUri,fieldKey)){return transformObject(schema,values,uri,uri);}function transformObjectSchemaArray(schema,values,{uri:parentUri,key:fieldKey},uri=(0,_common.getUri)(parentUri,fieldKey)){return transformArray(schema,values,uri,uri);}function transformObjectSchemaNumber(schema,values,{uri:parentUri,key:fieldKey},uri=(0,_common.getUri)(parentUri,fieldKey)){return transformNumber(schema,values,parentUri,uri);}function transformObjectSchemaString(schema,values,{uri:parentUri,key:fieldKey},uri=(0,_common.getUri)(parentUri,fieldKey)){return transformString(schema,values,parentUri,uri);}function transformObjectSchema(schema={},values={},params={}){const{type}=schema;switch(type){case'null':return transformObjectSchemaNull(schema,values,params);case'boolean':return transformObjectSchemaBoolean(schema,values,params);case'object':return transformObjectSchemaObject(schema,values,params);case'array':return transformObjectSchemaArray(schema,values,params);case'number':return transformObjectSchemaNumber(schema,values,params);case'string':return transformObjectSchemaString(schema,values,params);default:throw new Error('Schema does not conform to Instance Data Model, https://json-schema.org/draft/2019-09/json-schema-core.html#rfc.section.4.2.1');}}function transformArraySchemaNull(schema,values,{uri:parentUri,index:arrayIndex},uri=(0,_common.getUri)(parentUri,arrayIndex)){return transformNull(schema,values,parentUri,uri);}function transformArraySchemaBoolean(schema,values,{uri:parentUri,index:arrayIndex},uri=(0,_common.getUri)(parentUri,arrayIndex)){return transformBoolean(schema,values,parentUri,uri);}function transformArraySchemaObject(schema,values,{uri:parentUri,index:arrayIndex},uri=(0,_common.getUri)(parentUri,arrayIndex)){return transformObject(schema,values,uri,uri);}function transformArraySchemaArray(schema,values,{uri:parentUri,index:arrayIndex},uri=(0,_common.getUri)(parentUri,arrayIndex)){return transformArray(schema,values,uri,uri);}function transformArraySchemaNumber(schema,values,{uri:parentUri,index:arrayIndex},uri=(0,_common.getUri)(parentUri,arrayIndex)){return transformNumber(schema,values,parentUri,uri);}function transformArraySchemaString(schema,values,{uri:parentUri,index:arrayIndex},uri=(0,_common.getUri)(parentUri,arrayIndex)){return transformString(schema,values,parentUri,uri);}function transformArraySchema(schema={},values={},params={}){const{type}=schema;switch(type){case'null':return transformArraySchemaNull(schema,values,params);case'boolean':return transformArraySchemaBoolean(schema,values,params);case'object':return transformArraySchemaObject(schema,values,params);case'array':return transformArraySchemaArray(schema,values,params);case'number':return transformArraySchemaNumber(schema,values,params);case'string':return transformArraySchemaString(schema,values,params);default:throw new Error('Schema does not conform to Instance Data Model, https://json-schema.org/draft/2019-09/json-schema-core.html#rfc.section.4.2.1');}}function transformNull(schema,values,parentUri,uri){if(Reflect.has(values,uri)){const value=Reflect.get(values,uri);if((0,_common.hasEnum)(schema)){const array=(0,_common.getEnum)(schema);if((0,_common.isArray)(value))return value.map(v=>transformValueFor(v,array));return transformValueFor(value,array);}else{if((0,_common.hasAnyOf)(schema)){const array=(0,_common.getAnyOf)(schema);if((0,_common.isArray)(value))return value.map(v=>transformValueFor(v,array));return transformValueFor(value,array);}else{if((0,_common.hasOneOf)(schema)){const array=(0,_common.getOneOf)(schema);if((0,_common.isArray)(value))return value.map(v=>transformValueFor(v,array));return transformValueFor(value,array);}}}try{if((0,_common.isArray)(value))return value.map(toNull);return toNull(value);}catch(e){handleError(e);}return value;}}function transformBoolean(schema,values,parentUri,uri){if(Reflect.has(values,uri)){const value=Reflect.get(values,uri);if((0,_common.hasEnum)(schema)){const array=(0,_common.getEnum)(schema);if((0,_common.isArray)(value))return value.map(v=>transformValueFor(v,array));return transformValueFor(value,array);}else{if((0,_common.hasAnyOf)(schema)){const array=(0,_common.getAnyOf)(schema);if((0,_common.isArray)(value))return value.map(v=>transformValueFor(v,array));return transformValueFor(value,array);}else{if((0,_common.hasOneOf)(schema)){const array=(0,_common.getOneOf)(schema);if((0,_common.isArray)(value))return value.map(v=>transformValueFor(v,array));return transformValueFor(value,array);}}}try{if((0,_common.isArray)(value))return value.map(toBoolean);return toBoolean(value);}catch(e){handleError(e);}return value;}}function transformObject(schema,values,parentUri,uri){if((0,_common.hasEnum)(schema)){const array=(0,_common.getEnum)(schema);return getArrayFor(array,values,uri);}else{if((0,_common.hasAnyOf)(schema)){const array=(0,_common.getAnyOf)(schema);return getArrayFor(array,values,uri);}else{if((0,_common.hasOneOf)(schema)){const array=(0,_common.getOneOf)(schema);return getArrayFor(array,values,uri);}}}return transformObjectFor(schema,values,parentUri,uri);}function transformArray(schema,values,parentUri,uri){if((0,_common.hasEnum)(schema)){const array=(0,_common.getEnum)(schema);return getArrayFor(array,values,uri);}else{if((0,_common.hasAnyOf)(schema)){const array=(0,_common.getAnyOf)(schema);return getArrayFor(array,values,uri);}else{if((0,_common.hasOneOf)(schema)){const array=(0,_common.getOneOf)(schema);return getArrayFor(array,values,uri);}}}return transformArrayFor(schema,values,parentUri,uri);}function transformNumber(schema,values,parentUri,uri){if(Reflect.has(values,uri)){const value=Reflect.get(values,uri);if((0,_common.hasEnum)(schema)){const array=(0,_common.getEnum)(schema);if((0,_common.isArray)(value))return value.map(v=>transformValueFor(v,array));return transformValueFor(value,array);}else{if((0,_common.hasAnyOf)(schema)){const array=(0,_common.getAnyOf)(schema);if((0,_common.isArray)(value))return value.map(v=>transformValueFor(v,array));return transformValueFor(value,array);}else{if((0,_common.hasOneOf)(schema)){const array=(0,_common.getOneOf)(schema);if((0,_common.isArray)(value))return value.map(v=>transformValueFor(v,array));return transformValueFor(value,array);}}}try{if((0,_common.isArray)(value))return value.map(toNumber);return toNumber(value);}catch(e){handleError(e);}return value;}}function transformString(schema,values,parentUri,uri){if(Reflect.has(values,uri)){const value=Reflect.get(values,uri);if((0,_common.hasEnum)(schema)){const array=(0,_common.getEnum)(schema);if((0,_common.isArray)(value))return value.map(v=>transformValueFor(v,array));return transformValueFor(value,array);}else{if((0,_common.hasAnyOf)(schema)){const array=(0,_common.getAnyOf)(schema);if((0,_common.isArray)(value))return value.map(v=>transformValueFor(v,array));return transformValueFor(value,array);}else{if((0,_common.hasOneOf)(schema)){const array=(0,_common.getOneOf)(schema);if((0,_common.isArray)(value))return value.map(v=>transformValueFor(v,array));return transformValueFor(value,array);}}}try{if((0,_common.isArray)(value))return value.map(toString);return toString(value);}catch(e){handleError(e);}return value;}}function transform(rootSchema={},values={},parentUri='#',uri=(0,_common.getUri)(parentUri)){log('fromHashToDocument');const{type}=rootSchema;switch(type){case'null':return transformNull(rootSchema,values,parentUri,uri);case'boolean':return transformBoolean(rootSchema,values,parentUri,uri);case'object':return transformObject(rootSchema,values,parentUri,uri);case'array':return transformArray(rootSchema,values,parentUri,uri);case'number':return transformNumber(rootSchema,values,parentUri,uri);case'string':return transformString(rootSchema,values,parentUri,uri);default:throw new Error('Schema does not conform to Instance Data Model, https://json-schema.org/draft/2019-09/json-schema-core.html#rfc.section.4.2.1');}}