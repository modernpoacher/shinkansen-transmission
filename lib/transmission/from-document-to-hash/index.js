"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.getObject=getObject;exports.getArray=getArray;exports.getSchema=getSchema;exports.transformValueIndexFor=transformValueIndexFor;exports.transformEqualIndexFor=transformEqualIndexFor;exports.transformArrayFor=transformArrayFor;exports.transformObjectFor=transformObjectFor;exports.transformArray=transformArray;exports.transformObject=transformObject;exports.default=transform;exports.transformValue=void 0;var _debug=_interopRequireDefault(require("debug"));var _fastDeepEqual=_interopRequireDefault(require("fast-deep-equal"));var _common=require("../common");function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}const log=(0,_debug.default)('shinkansen-transmission:from-document-to-hash');function findByKey(parentUri,uri){return function find(key){return uri===(0,_common.getUri)(parentUri,key);};}function findByIndex(parentUri,uri){return function find(schema,index){if((0,_common.hasEnum)(schema)){}else{if((0,_common.hasAnyOf)(schema)){const array=(0,_common.getAnyOf)(schema);return array.find(findByIndex(parentUri,uri));}else{if((0,_common.hasOneOf)(schema)){const array=(0,_common.getOneOf)(schema);return array.find(findByIndex(parentUri,uri));}}}return(0,_common.getUri)(parentUri,index)===uri;};}function findByValue(value){return function find(schema){return value===transformValue(schema);};}function findByEqual(value){return function find(schema){return(0,_fastDeepEqual.default)(value,transformValue(schema));};}function getObject({properties={}}={},parentUri,uri){return Reflect.get(properties,Object.keys(properties).find(findByKey(parentUri,uri)));}function getArray({items={}}={},parentUri,uri){return(0,_common.isArray)(items)?items.find(findByIndex(parentUri,uri)):items;}function getSchema(schema={},parentUri,uri){const{type}=schema;switch(type){case'object':return getObject(schema,parentUri,uri);case'array':return getArray(schema,parentUri,uri);default:return schema;}}const transformValue=schema=>(0,_common.isObject)(schema)?(0,_common.isConstValue)(schema)?(0,_common.toConstValue)(schema):(0,_common.isDefaultValue)(schema)?(0,_common.toDefaultValue)(schema):schema:schema;exports.transformValue=transformValue;function transformValueIndexFor(array,value){const find=findByValue(value);if(array.some(find)){const index=array.findIndex(find);return String(index);}return String(value);}function transformEqualIndexFor(array,value){const find=findByEqual(value);if(array.some(find)){const index=array.findIndex(find);return String(index);}return String(value);}function transformArrayFor(document,schema,values,params,parentUri,uri){return document.reduce((values,value,index)=>{const schemaUri=(0,_common.getUri)(parentUri,index);return transform(value,getSchema(schema,parentUri,schemaUri),values,params,schemaUri,schemaUri);},values);}function transformObjectFor(document,schema,values,params,parentUri,uri){return Object.entries(document).reduce((values,[key,value])=>{const schemaUri=(0,_common.getUri)(parentUri,key);return transform(value,getSchema(schema,parentUri,schemaUri),values,params,schemaUri,schemaUri);},values);}function transformArray(document,schema,values,params,parentUri,uri){if((0,_common.hasEnum)(schema)){const array=(0,_common.getEnum)(schema);return{...values,[uri]:document.map(value=>transformValueIndexFor(array,value))};}else{if((0,_common.hasAnyOf)(schema)){const array=(0,_common.getAnyOf)(schema);return{...values,[uri]:document.map(value=>transformValueIndexFor(array,value))};}else{if((0,_common.hasOneOf)(schema)){const array=(0,_common.getOneOf)(schema);return{...values,[uri]:document.map(value=>transformValueIndexFor(array,value))};}else{const{items={}}=schema;if((0,_common.isArray)(items)){return transformArrayFor(document,schema,values,params,parentUri,uri);}else{if((0,_common.isObject)(items)){if((0,_common.hasEnum)(items)){const array=(0,_common.getEnum)(items);return{...values,[uri]:document.map(value=>transformValueIndexFor(array,value))};}else{if((0,_common.hasAnyOf)(items)){const array=(0,_common.getAnyOf)(items);return{...values,[uri]:document.map(value=>transformValueIndexFor(array,value))};}else{if((0,_common.hasOneOf)(items)){const array=(0,_common.getOneOf)(items);return{...values,[uri]:document.map(value=>transformValueIndexFor(array,value))};}}}}}}}}return transformArrayFor(document,schema,values,params,parentUri,uri);}function transformObject(document,schema,values,params,parentUri,uri){if((0,_common.hasEnum)(schema)){const array=(0,_common.getEnum)(schema);return{...values,[uri]:transformEqualIndexFor(array,document)};}else{if((0,_common.hasAnyOf)(schema)){const array=(0,_common.getAnyOf)(schema);return{...values,[uri]:transformEqualIndexFor(array,document)};}else{if((0,_common.hasOneOf)(schema)){const array=(0,_common.getOneOf)(schema);return{...values,[uri]:transformEqualIndexFor(array,document)};}}}return transformObjectFor(document,schema,values,params,parentUri,uri);}function transform(document,schema={},values={},params={},parentUri='#',uri=(0,_common.getUri)(parentUri)){log('fromDocumentToHash');if((0,_common.isArray)(document)){return transformArray(document,schema,values,params,parentUri,uri);}else{if((0,_common.isObject)(document)){return transformObject(document,schema,values,params,parentUri,uri);}else{if((0,_common.hasEnum)(schema)){const items=(0,_common.getEnum)(schema);return{...values,[uri]:transformValueIndexFor(items,document)};}else{if((0,_common.hasAnyOf)(schema)){const items=(0,_common.getAnyOf)(schema);return{...values,[uri]:transformValueIndexFor(items,document)};}else{if((0,_common.hasOneOf)(schema)){const items=(0,_common.getOneOf)(schema);return{...values,[uri]:transformValueIndexFor(items,document)};}}}}}return{...values,[uri]:String(document)};}